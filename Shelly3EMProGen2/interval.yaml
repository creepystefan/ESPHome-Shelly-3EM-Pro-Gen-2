#"n_current"
#"total_current"
#"total_act_power"
#"total_aprt_power"
# user_calibrated_phase
# emdata
#a_total_act_energy
#a_total_act_ret_energy"
#"b_total_act_energy"
#"b_total_act_ret_energy
#"c_total_act_energy"
#"c_total_act_ret_energy
#"total_act"
#"total_act_ret"
#"eth":{"ip":null},
#"modbus":{},
#"mqtt":{"connected":true},
#"sys":{"mac":"MAC ADRESS"
#"restart_required"
#"time"
#"unixtime"
#"uptime"
#"ram_size"
#"ram_free"
#"fs_size"
#"fs_free"
#"cfg_rev"
#"kvs_rev"
#"schedule_rev"
#"webhook_rev"
#"available_updates"{"stable":{"version":"1.2.2"}},
#"reset_reason"
#"temperature:0":{"id": 0,"tC":46.9, "tF":116.5},"
#"wifi":{"sta_ip":"YOUR IP","status":"got ip","ssid":"YOUR SSID","rssi":-65}
#"ws":{"connected":false}}

interval:
  - interval: 1s
    then:
      - http_request.get:
          url: http://${ShellyIP}/rpc/Shelly.GetStatus
          verify_ssl: false
          headers:
            Content-Type: application/json
          capture_response: true
          max_response_buffer_size: 4096
          on_response:
            then:
              - lambda: |-
                  json::parse_json(body, [](JsonObject root) -> bool {
                      id(id).publish_state(root["em:0"]["id"].as< float >());
                      
                      id(a_voltage).publish_state(root["em:0"]["a_voltage"].as< float >());
                      id(a_current).publish_state(root["em:0"]["a_current"].as< float >());
                      id(a_freq).publish_state(root["em:0"]["a_freq"].as< float >());
                      id(a_act_power).publish_state(root["em:0"]["a_act_power"].as< float >());
                      id(a_aprt_power).publish_state(root["em:0"]["a_aprt_power"].as< float >());
                      id(a_pf).publish_state(root["em:0"]["a_pf"].as< float >());

                      id(b_voltage).publish_state(root["em:0"]["b_voltage"].as< float >());
                      id(b_current).publish_state(root["em:0"]["b_current"].as< float >());
                      id(b_freq).publish_state(root["em:0"]["b_freq"].as< float >());
                      id(b_act_power).publish_state(root["em:0"]["b_act_power"].as< float >());
                      id(b_aprt_power).publish_state(root["em:0"]["b_aprt_power"].as< float >());
                      id(b_pf).publish_state(root["em:0"]["b_pf"].as< float >());
                      
                      id(c_voltage).publish_state(root["em:0"]["c_voltage"].as< float >());
                      id(c_current).publish_state(root["em:0"]["c_current"].as< float >());
                      id(c_freq).publish_state(root["em:0"]["c_freq"].as< float >());
                      id(c_act_power).publish_state(root["em:0"]["c_act_power"].as< float >());
                      id(c_aprt_power).publish_state(root["em:0"]["c_aprt_power"].as< float >());
                      id(c_pf).publish_state(root["em:0"]["c_pf"].as< float >());
                                          
                      return true;
                  });

# https://github.com/esphome/issues/issues/5951
# https://github.com/XavierBerger/Solar-Router-for-ESPHome/blob/main/solar_router/power_meter_shelly_em.yaml
 #          then:
 #             - lambda: |-
 #                 json::parse_json(id(getrequest).get_string(), [](JsonObject root) {
 #                     id(id).publish_state(root["em:0"]["id"]);
 #                     id(a_voltage).publish_state(root["em:0"]["a_voltage"]);
 #                     id(b_voltage).publish_state(root["em:0"]["b_voltage"]);
 #                     id(c_voltage).publish_state(root["em:0"]["c_voltage"]);
 #                     id(a_freq).publish_state(root["em:0"]["a_freq"]);
 #                     id(b_freq).publish_state(root["em:0"]["b_freq"]);
 #                     id(c_freq).publish_state(root["em:0"]["c_freq"]);
 #                     
 #                 });
